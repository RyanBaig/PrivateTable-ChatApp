<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Socket.IO chat</title>
  <link rel="stylesheet" href="/css">
</head>

<body>
  <button onclick="location.reload();" class="reload-button">
    <svg xmlns="http://www.w3.org/2000/svg" height="16" width="16"
      viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 1980 Fonticons, Inc.-->
      <path
        d="M105.1 202.6c7.7-21.8 20.2-42.3 37.8-59.8c62.5-62.5 163.8-62.5 226.3 0L386.3 160H352c-17.7 0-32 14.3-32 32s14.3 32 32 32H463.5c0 0 0 0 0 0h.4c17.7 0 32-14.3 32-32V80c0-17.7-14.3-32-32-32s-32 14.3-32 32v35.2L414.4 97.6c-87.5-87.5-229.3-87.5-316.8 0C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5zM39 289.3c-5 1.5-9.8 4.2-13.7 8.2c-4 4-6.7 8.8-8.1 14c-.3 1.2-.6 2.5-.8 3.8c-.3 1.7-.4 3.4-.4 5.1V432c0 17.7 14.3 32 32 32s32-14.3 32-32V396.9l17.6 17.5 0 0c87.5 87.4 229.3 87.4 316.7 0c24.4-24.4 42.1-53.1 52.9-83.7c5.9-16.7-2.9-34.9-19.5-40.8s-34.9 2.9-40.8 19.5c-7.7 21.8-20.2 42.3-37.8 59.8c-62.5 62.5-163.8 62.5-226.3 0l-.1-.1L125.6 352H160c17.7 0 32-14.3 32-32s-14.3-32-32-32H48.4c-1.6 0-3.2 .1-4.8 .3s-3.1 .5-4.6 1z" />
    </svg>
  </button>
  <ul id="messages"></ul>

  <div class="gridContainer">

    <form id="form" action="">
      <div id="filePreview"></div>
      <input type="file" id="fileUploader">
      <label for="fileUploader" class="custom-file-upload">
        <svg xmlns="http://www.w3.org/2000/svg" height="16" width="14"
          viewBox="0 0 448 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 1980 Fonticons, Inc.-->
          <path fill="white"
            d="M246.6 9.4c-12.5-12.5-32.8-12.5-45.3 0l-128 128c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 109.3V320c0 17.7 14.3 32 32 32s32-14.3 32-32V109.3l73.4 73.4c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-128-128zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32v64c0 53 43 96 96 96H352c53 0 96-43 96-96V352c0-17.7-14.3-32-32-32s-32 14.3-32 32v64c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V352z" />
        </svg>
        Upload File
      </label>
      <input id="m" autocomplete="off" placeholder="Type a message..." />
      <button>Send</button>
    </form>

  </div>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
  <script type="module">
    // Helper function to split the message into chunks of 120 characters
    function splitIntoChunks(str, len) {
      var regex = new RegExp('.{' + len + '}|.{1,' + Number(len - 1) + '}', 'g');
      return str.match(regex);
    }

    function addMessage(message) {

      var messagesList = document.getElementById('messages');
      var messageItem = document.createElement('li');
      messageItem.classList.add('message-item');

      // Create an img element if an image URL is provided
      if (message.imageUrl) {
        var imgElement = document.createElement('img');
        imgElement.src = message.imageUrl;
        imgElement.style.cssText = 'max-width: 200px; height: auto;';
        messageItem.appendChild(imgElement);
      }

      // Split the message into chunks of 120 characters
      var messageChunks = splitIntoChunks(message.data, 120);

      // Create a div for each chunk of message
      messageChunks.forEach(chunk => {
        var messageDiv = document.createElement('div');
        messageDiv.style.cssText = 'word-wrap: break-word; display: flex;';

        // Create a span for each line of the chunk
        chunk.split('\n').forEach(line => {
          var lineDiv = document.createElement('div');
          var messageText = document.createTextNode(line);
          lineDiv.appendChild(messageText);
          messageDiv.appendChild(lineDiv);
        });

        messageItem.appendChild(messageDiv);
      });

      var timestamp = document.createElement('span');
      timestamp.classList.add('timestamp');
      timestamp.style.cssText = 'text-align: right;';

      var timestampText = document.createTextNode(message.timestamp);
      timestamp.appendChild(timestampText);

      messageItem.appendChild(timestamp);

      messagesList.appendChild(messageItem);
    }

    var socket = io();

    // Initialize the AppWrite client
    const client = new Appwrite.Client();


    client.setEndpoint('https://cloud.appwrite.io/v1'); // Your Appwrite Endpoint
    client.setProject('privatetable-chat'); // Your project ID


    // Initialize Database service
    const database = new Appwrite.Databases(client, "chat-msgs");


    // Event listener for form submission
    document.getElementById('form').addEventListener('submit', function (e) {
      e.preventDefault();

      var message = document.getElementById('m').value;
      var file = document.getElementById('fileUploader').files[0];

      if (file) {
        // If a file is selected, upload it and send the message along with the file
        socket.emit('file_upload', {
          message: message,
          file: file
        });
      } else {
        // If no file is selected, just send the message
        socket.emit('chat_message', message);
      }

      document.getElementById('m').value = '';
      return false;
    });

    // Event listener for receiving messages
    socket.on('message', function (message) {
      addMessage(JSON.parse(message));
    });

    // Function to fetch messages from AppWrite
    function fetchMessages() {
      database.listDocuments("chat-msgs", "chat-msgs-collection")
        .then(function (response) {
          var messagesList = document.getElementById('messages');
          messagesList.innerHTML = ''; // Clear existing messages

          // Add each message to the list
          response.documents.forEach(function (document) {
            var timestamp = document.timestamp; // Assuming timestamp is a property of the document
            var messageContent = document.message; // Replace with the actual property name
            var imageUrl = document.image_url || null; // Get the image URL

            addMessage({
              timestamp: timestamp,
              data: messageContent,
              imageUrl: imageUrl
            });
          });
        })
        .catch(function (error) {
          console.error('Error fetching messages from Cloud: ', error);
        });
    }


    // Call fetchMessages when the page loads to load existing messages
    fetchMessages();

    // Handle the uploading
    document.getElementById('form').addEventListener('submit', function (e) {
      e.preventDefault();
      var file = document.getElementById('fileUploader').files[0];
      socket.emit('file_upload', file);
    });

    // preview of file
    document.getElementById('fileUploader').addEventListener('change', function (e) {
      // Clear the old image preview
      document.getElementById('filePreview').innerHTML = '';

      // Get the selected file
      var file = e.target.files[0];

      // Check if the file is an image
      if (file.type.startsWith('image/')) {
        // Create a URL for the file
        var url = URL.createObjectURL(file);

        // Create an img element and set its src attribute to the file URL
        var imgElement = document.createElement('img');
        imgElement.src = url;
        imgElement.style = "max-height: 200px; max-width: 200px; display: block; align-self: flex-end;"

        // Append the img element to the document
        document
          .getElementById("filePreview")
          .appendChild(imgElement);
      } else {
        // For non-image files, display a generic icon
        var imgElement = document.createElement('img');
        imgElement.src = '/icon/file.svg';

        document
          .getElementById("filePreview")
          .appendChild(imgElement);
      }
    });

    document.querySelector('.custom-file-upload').addEventListener('click', function () {
      document.getElementById('fileUploader').click();
    });
  </script>
</body>

</html>